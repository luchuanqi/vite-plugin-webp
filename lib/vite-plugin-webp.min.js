/*!
 * vite-plugin-webp v1.1.2
 * (c) Mon Feb 06 2023 15:34:21 GMT+0800 (China Standard Time) luchuanqi
 * Released under the MIT License.
 */
"use strict";var fs=require("fs"),path=require("path"),sharp=require("sharp"),cssjson=require("cssjson");function _interopDefaultLegacy(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var fs__default=_interopDefaultLegacy(fs),path__default=_interopDefaultLegacy(path),sharp__default=_interopDefaultLegacy(sharp);function __awaiter(e,t,r,s){return new(r||(r=Promise))((function(a,n){function i(e){try{l(s.next(e))}catch(e){n(e)}}function o(e){try{l(s.throw(e))}catch(e){n(e)}}function l(e){var t;e.done?a(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(i,o)}l((s=s.apply(e,t||[])).next())}))}const styleReg=/<style([^<>]*)>([^<>]+)<\/style>/gm,cssUrlReg=/url\((.+)\).*/gm,resizeReg=/\D+(\d+)[xX*](\d+)\.webp$/,config={joiner:"!"};function toArray(e){return"string"==typeof e?e?[e]:[]:e}function isDirectory(e){return fs__default.default.statSync(e).isDirectory()}function evalCatch(data){try{return eval(data)}catch(e){return data}}function getAbsoluteDir(e,t,r){const s=t.split("/"),{replacement:a}=r.find((e=>e.find===s[0]))||{};let n="";return n=a?`${a}/${s.slice(1).join("/")}`:path__default.default.join(e,"../",t),n}function isTargetImage(e,t){const r=evalCatch(e).split("."),s=r[r.length-1];return t.includes(`.${s}`)}function getWebpPath(e){const t=e.split("."),r=t[t.length-1],s=new RegExp(`${r}$`);return e.replace(s,"webp")}var helper={toArray:toArray,isDirectory:isDirectory,evalCatch:evalCatch,isTargetImage:isTargetImage,getWebpPath:getWebpPath,getAbsoluteDir:getAbsoluteDir};class Filter{constructor(e){this.result=[],this.rules=e.rules||["width"],this.options=e.options,this.loopDate(e.data)}getData(){return this.result}loopDate(e,t=""){for(let r in e)if("object"==typeof e[r]){const s=t?`${t}${config.joiner}${r}`:r;this.loopDate(e[r],s)}else cssUrlReg.lastIndex=0,this.rules.includes(r)&&cssUrlReg.test(e[r])&&helper.isTargetImage(RegExp.$1,this.options.imageType)&&this.result.push({pre:t,style:{[r]:e[r]}})}}class Standard{constructor(e){this.data=e.data||[],this.result=[],this.transformData(this.data)}getData(){return this.result}transformData(e){this.result=e.map((e=>this.toTreeData(e)))}treeLoop(e,t,r){if(Object.keys(e).length)for(let s in e)e[s]?this.treeLoop(e[s],t,r):e[t]={};else"attributes"===t?(e.children={},e.attributes=r):e[t]={}}toTreeData(e){const t={};return e.pre.split(config.joiner).forEach(((r,s)=>{0===s?t[r]={}:this.treeLoop(t,r,e.style)})),t}}const sharpWebp=(e,t,r)=>{let s=null,a=null;return resizeReg.lastIndex=0,resizeReg.test(t)&&(s=Number(RegExp.$1),a=Number(RegExp.$2)),new Promise(((n,i)=>{try{sharp__default.default(e).resize({width:s,height:a}).webp(r||{}).toFile(t,((e,t)=>{e?i(e):n(t)}))}catch(e){i(e)}}))},replaceItem=(e,t,{id:r})=>new Promise((s=>{const{alias:a,sharpOptions:n}=t;if(cssUrlReg.lastIndex=0,cssUrlReg.test(e)){const t=helper.evalCatch(RegExp.$1),i=helper.getAbsoluteDir(r,t,a),o=helper.getWebpPath(i),l=helper.getWebpPath(t);fs__default.default.existsSync(o)?s(e.replace(t,l)):sharpWebp(i,o,n).then((()=>{s(e.replace(t,l))})).catch((()=>{s("")}))}})),replaceAll=(e,t,{id:r})=>__awaiter(void 0,void 0,void 0,(function*(){const{container:s}=t;let a="";for(let n=0;n<e.length;){const i=cssjson.toCSS(e[n]);!1===i.startsWith(s)&&(a+=(yield replaceItem(`${s} ${i}`,t,{id:r}))),n++}return a})),styleTransform=function(e,{code:t,id:r}){return __awaiter(this,void 0,void 0,(function*(){const{rules:s}=e;let a="";for(;styleReg.test(t);){const t=RegExp.$1,n=new Filter({data:cssjson.toJSON(RegExp.$2),rules:s,options:e}),i=new Standard({data:n.getData()}).getData(),o=yield replaceAll(i,e,{id:r});a+=o?`<style ${t}>\n${o}</style>\n`:""}return a}))},cssTransform=function(e,{code:t,id:r}){return __awaiter(this,void 0,void 0,(function*(){const{rules:s}=e,a=new Filter({data:cssjson.toJSON(t),rules:s,options:e}),n=new Standard({data:a.getData()}).getData();return yield replaceAll(n,e,{id:r})}))},transform=function(e,t){return __awaiter(this,void 0,void 0,(function*(){const{formate:{css:r,template:s}}=e;let{code:a,id:n}=t;n.split("?");let i="";const o=new RegExp(`.+(${r.join("|")})$`),l=new RegExp(`.+(${s.join("|")})$`);return o.test(n)?i=yield cssTransform(e,{code:a,id:n}):l.test(n)&&(i=yield styleTransform(e,{code:a,id:n})),{code:i?a+i:a,map:null}}))};var name="vite-plugin-webp";class Ignore{static suffixFile(e,t){const{formate:r}=t,{css:s,template:a}=r;return new RegExp(`.+(${s.concat(a).join("|")})$`).test(e)}static includeDir(e,t){const r=helper.toArray(t.include);let s=!1;for(let t=0;t<r.length;t++){const a=r[t];if(e.startsWith(a)){s=!0;break}}return s}static decludeDir(e,t){const r=helper.toArray(t.declude);let s=!0;for(let t=0;t<r.length;t++){const a=r[t];if(e.startsWith(a)){s=!1;break}}return s}}const ignoreFiles=(e,t)=>Ignore.suffixFile(e,t)&&Ignore.includeDir(e,t)&&Ignore.decludeDir(e,t);function createWebp(e,t){if(!1===fs__default.default.existsSync(e))return;const{imageType:r,sharpOptions:s}=t;fs__default.default.readdirSync(e).forEach((a=>{const n=path__default.default.join(e,a);if(helper.isDirectory(n))createWebp(n,t);else if(helper.isTargetImage(n,r)){const e=helper.getWebpPath(n);sharpWebp(n,e,s)}}))}const webp=e=>{const{onlyWebp:t}=e,r=helper.toArray(t);for(let t=0;t<r.length;t++){createWebp(r[t],e)}},DEFAULT_FORMATE={css:[".css",".less",".scss",".sass"],template:[".vue",".html"]},DEFAULT_OPTIONS={container:".g-webp",rules:["background","background-image"],imageType:[".png",".jpg"],formate:DEFAULT_FORMATE,onlyWebp:"",include:"",sharpOptions:{},declude:"node_modules"};function main(e={}){const t=Object.assign(Object.assign(Object.assign({},DEFAULT_OPTIONS),e),{formate:Object.assign(Object.assign({},DEFAULT_OPTIONS.formate),e.formate)});return webp(t),{name:name,enforce:"pre",configResolved(e){var r;t.alias=(null===(r=null==e?void 0:e.resolve)||void 0===r?void 0:r.alias)||[]},transform(e,r){if(!1!==ignoreFiles(r,t))return transform(t,{code:e,id:r})}}}module.exports=main;
